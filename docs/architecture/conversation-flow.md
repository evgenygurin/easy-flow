# Conversation Flow

Модель: конечный автомат состояний с контекстом сессии (`FlowContext`). Базовые состояния: `hello`, `order`, `payment`, `shipping`, `hangup`.

- Вход: `user_id`, `session_id`, `message`, `platform`, `intent`, `entities`.
- Контекст: история, извлечённые сущности, предпочтения пользователя, счётчики, история переходов.
- Результат `StateResult`: `response`, `requires_input`, `next_state`, `should_continue`, `suggested_actions`, `metadata`.
- Эскалация: по метаданным состояния, сигналам контекста (длина диалога, зацикливание, сложные интенты).

Переходы (упрощённо)
- `hello` → `order|payment|shipping|hangup`
- `order` ↔ `payment|shipping|hello|hangup`
- `payment` ↔ `order|shipping|hello|hangup`
- `shipping` ↔ `order|payment|hello|hangup`
- `hangup` — терминальное.

Генерация «следующих вопросов»
- По доступным действиям состояния генерируются уточняющие вопросы (до 3 шт).

Метрики
- Активные сессии, распределение по состояниям, доля сессий с эскалацией.

Админ‑операции
- Получить состояние сессии: текущее состояние, переходы, признаки эскалации.
- Принудительный переход в состояние.
- Очистка неактивных сессий.

Риски и тактика
- Риск зацикливания → детекция повторов состояний.
- Низкая уверенность NLP → эскалация/уточняющие вопросы.
- Расширяемость → добавлять новые состояния с методом `can_transition_to` и `get_available_actions`.
