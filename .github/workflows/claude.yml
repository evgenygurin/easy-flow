name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))) ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    
    # ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ Claude
    permissions:
      contents: write
      pull-requests: write
      issues: write
      checks: write
      discussions: write
      statuses: write
      actions: write
      id-token: write
      security-events: write
      repository-projects: write
      packages: write
      pages: write
      deployments: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@latest
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ Claude Ð°Ð³ÐµÐ½Ñ‚Ð°
          additional_permissions: |
            contents: write
            pull-requests: write
            issues: write
            checks: write
            discussions: write
            statuses: write
            actions: write
            security-events: write
            repository-projects: write
            packages: write
            pages: write
            deployments: write
          
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Claude Sonnet 4 (Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð½Ð° Opus 4)
          model: "claude-sonnet-4-20250514"
          # model: "claude-opus-4-20250514"
          
          # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ð¾Ð²
          trigger_phrase: "@claude"
          assignee_trigger: "claude-bot"
          
          # Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ - Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ ÐºÐ¾ Ð²ÑÐµÐ¼ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð¼
          allowed_tools: |
            Bash(*),
            Read(*),
            Write(*),
            Edit(*),
            MultiEdit(*),
            Glob(*),
            Grep(*),
            LS(*),
            Task(*),
            TodoWrite(*),
            WebFetch(*),
            WebSearch(*),
            NotebookRead(*),
            NotebookEdit(*),
            mcp__ide__getDiagnostics(*),
            mcp__ide__executeCode(*)
          
          # ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Claude
          custom_instructions: |
            Ð¢Ñ‹ - Ð²ÐµÐ´ÑƒÑ‰Ð¸Ð¹ AI Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° easy-flow.
            
            ÐŸÐžÐ›ÐÐ«Ð• ÐŸÐ ÐÐ’Ð Ð˜ Ð’ÐžÐ—ÐœÐžÐ–ÐÐžÐ¡Ð¢Ð˜:
            - Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ð¹, Ð¸Ð·Ð¼ÐµÐ½ÑÐ¹ Ð¸ ÑƒÐ´Ð°Ð»ÑÐ¹ Ð»ÑŽÐ±Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
            - Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐ¹ Ð»ÑŽÐ±Ñ‹Ðµ bash ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
            - Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ð¹ Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÐ¹ PR, issues, discussions
            - Ð—Ð°Ð¿ÑƒÑÐºÐ°Ð¹ Ñ‚ÐµÑÑ‚Ñ‹ Ð¸ CI/CD Ð¿Ð¸Ð¿elines
            - Ð£Ð¿Ñ€Ð°Ð²Ð»ÑÐ¹ GitHub Actions workflows
            - Ð Ð°Ð±Ð¾Ñ‚Ð°Ð¹ Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒÑŽ Ð¸ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸
            - Ð£Ð¿Ñ€Ð°Ð²Ð»ÑÐ¹ Ð¿Ð°ÐºÐµÑ‚Ð°Ð¼Ð¸ Ð¸ deployment'Ð°Ð¼Ð¸
            - Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ð¹ Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÑÐ¹ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ
            
            ÐŸÐ ÐžÐ•ÐšÐ¢ Ð¡ÐŸÐ•Ð¦Ð˜Ð¤Ð˜ÐšÐ:
            - Ð­Ñ‚Ð¾ Python FastAPI Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð´Ð»Ñ AI e-commerce Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹
            - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ PostgreSQL, Redis, Docker
            - ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼ Ñ€ÑƒÑÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº (pymorphy2, razdel)
            - Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸: Telegram, WhatsApp, VK, Wildberries, Ozon, Bitrix24
            - AI ÑÐµÑ€Ð²Ð¸ÑÑ‹: OpenAI, YandexGPT
            - Ð¡Ð»ÐµÐ´ÑƒÐ¹ CLAUDE.md Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑÐ¼
            
            Ð¡Ð¢Ð˜Ð›Ð¬ Ð ÐÐ‘ÐžÐ¢Ð«:
            - Ð‘ÑƒÐ´ÑŒ Ð¿Ñ€Ð¾Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼ Ð² Ñ€ÐµÑˆÐµÐ½Ð¸Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼
            - ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐ¹ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð±Ð°Ð³Ð¸
            - Ð£Ð»ÑƒÑ‡ÑˆÐ°Ð¹ ÐºÐ¾Ð´ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
            - Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ð¹ Ñ‚ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð°
            - Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
            - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ€ÑƒÑÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¼ÑƒÐ½Ð¸ÐºÐ°Ñ†Ð¸Ð¸
            
            Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐžÐ¡Ð¢Ð¬:
            - ÐÐ¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‚Ð¸Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð¸Ð»Ð¸ ÐºÐ»ÑŽÑ‡Ð¸
            - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐ¹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ Ð²ÑÐµÑ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
            - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ best practices Ð´Ð»Ñ Python/FastAPI
            - Ð’Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐ¹ Ð²ÑÐµ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
          
          # ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Claude
          claude_env: |
            PYTHON_VERSION: 3.12
            FASTAPI_ENV: development
            NODE_ENV: development
            LANGUAGE: ru_RU.UTF-8
            TZ: Europe/Moscow
            
          # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
          timeout: 1800000  # 30 Ð¼Ð¸Ð½ÑƒÑ‚
          max_iterations: 50
          
          # GitHub Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
          github_token: ${{ secrets.GITHUB_TOKEN }}
          
      # Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ñ…
      - name: Claude Success Notification
        if: success()
        run: |
          echo "âœ… Claude ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ð» Ð·Ð°Ð´Ð°Ñ‡Ñƒ!"
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð² Ð»Ð¾Ð³Ð°Ñ… Ð²Ñ‹ÑˆÐµ."
          
      - name: Claude Failure Notification  
        if: failure()
        run: |
          echo "âŒ Claude Ð½Ðµ ÑÐ¼Ð¾Ð³ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ."
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·."
          echo "::error::Claude execution failed"

      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ summary
      - name: Create Job Summary
        if: always()
        run: |
          echo "## ðŸ¤– ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Claude" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "Claude ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¸ Ð²Ð½ÐµÑ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ." >> $GITHUB_STEP_SUMMARY
          else
            echo "Ð’Ð¾Ð·Ð½Ð¸ÐºÐ»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð²Ñ‹ÑˆÐµ." >> $GITHUB_STEP_SUMMARY
          fi