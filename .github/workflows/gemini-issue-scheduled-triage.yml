name: üìã –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ issue –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (Gemini)

on:
  schedule:
    - cron: '0 * * * *' # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å
  workflow_dispatch: {}

jobs:
  triage-issues:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      issues: write
    steps:
      - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ GitHub App
        id: generate_token
        if: ${{ vars.APP_ID }}
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}

      - name: –ü–æ–∏—Å–∫ –Ω–µ–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö issue
        id: find_issues
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç –ü–æ–∏—Å–∫ issue –±–µ–∑ –º–µ—Ç–æ–∫..."
          NO_LABEL_ISSUES=$(gh issue list --repo ${{ github.repository }} --search "is:open is:issue no:label" --json number,title,body)

          echo "üè∑Ô∏è –ü–æ–∏—Å–∫ issue, —Ç—Ä–µ–±—É—é—â–∏—Ö —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏..."
          NEED_TRIAGE_ISSUES=$(gh issue list --repo ${{ github.repository }} --search "is:open is:issue label:\"status/needs-triage\"" --json number,title,body)

          echo "üîÑ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ issue..."
          ISSUES=$(echo "$NO_LABEL_ISSUES" "$NEED_TRIAGE_ISSUES" | jq -c -s 'add | unique_by(.number)')

          echo "üìù –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã–≤–æ–¥–∞ –¥–ª—è GitHub Actions..."
          echo "issues_to_triage=$ISSUES" >> "$GITHUB_OUTPUT"

          echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ $(echo "$ISSUES" | jq 'length') issue –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏! üéØ"

      - name: –ó–∞–ø—É—Å–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ issue —Å –ø–æ–º–æ—â—å—é Gemini
        if: steps.find_issues.outputs.issues_to_triage != '[]'
        uses: google-gemini/gemini-cli-action@main
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          ISSUES_TO_TRIAGE: ${{ steps.find_issues.outputs.issues_to_triage }}
          REPOSITORY: ${{ github.repository }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OTLP_GCP_WIF_PROVIDER: ${{ secrets.OTLP_GCP_WIF_PROVIDER }}
          OTLP_GOOGLE_CLOUD_PROJECT: ${{ secrets.OTLP_GOOGLE_CLOUD_PROJECT }}
          settings_json: |
            {
              "coreTools": [
                "run_shell_command(echo)",
                "run_shell_command(gh label list)",
                "run_shell_command(gh issue edit)",
                "run_shell_command(gh issue list)"
              ],
              "telemetry": {
                "enabled": true,
                "target": "gcp"
              },
              "sandbox": false
            }
          prompt: |
            –¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ issue. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–∏–º–µ–Ω—è–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–∫–∏.
            
            –®–∞–≥–∏:
            1. –í—ã–ø–æ–ª–Ω–∏: `gh label list`
            2. –ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è: $ISSUES_TO_TRIAGE (JSON-–º–∞—Å—Å–∏–≤ —Å –∑–∞–¥–∞—á–∞–º–∏)
            3. –î–ª—è –∫–∞–∂–¥–æ–π issue –ø—Ä–∏–º–µ–Ω–∏ –º–µ—Ç–∫–∏: `gh issue edit ISSUE_NUMBER --add-label "–º–µ—Ç–∫–∞1,–º–µ—Ç–∫–∞2"`. –ï—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, —É—Å—Ç–∞–Ω–æ–≤–∏ –º–µ—Ç–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —à–∞–±–ª–æ–Ω–∞–º `kind/*`, `area/*` –∏ `priority/*`.
            4. –î–ª—è –∫–∞–∂–¥–æ–π issue, –µ—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–µ—Ç–∫–∞ `status/needs-triage`, —É–¥–∞–ª–∏ –µ—ë —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã: `gh issue edit ISSUE_NUMBER --remove-label "status/needs-triage"`
            
            –ü—Ä–∞–≤–∏–ª–∞:
            - –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –º–µ—Ç–∫–∏.
            - –ù–µ –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
            - –°–æ—Ä—Ç–∏—Ä—É–π –∫–∞–∂–¥—É—é issue –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.
